<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  	<mapper namespace="com.kcFinder.dev.domain.product.UserProductRepository">
  	
  	<insert id="insertUserProduct" parameterType="com.kcFinder.dev.domain.product.UserProduct"
  	useGeneratedKeys="true" keyProperty="product_code">
  	insert into
		user_product(
			product_code,
			user_code,
			product_name,
			create_date,
			update_date
		)
	values(
		0,
		#{user_code},
		#{product_name},
		now(),
		now()
		);
		
  	</insert>
  	
  	<insert id="insertUserProductFile" parameterType="com.kcFinder.dev.domain.product.UserProductFile"
  	useGeneratedKeys="true" keyProperty="product_img_code">
  	insert into
		user_product_img(
			product_img_code,
			product_code,
			product_img_path,
			create_date,
			update_date
		)
	values(
		0,
		#{product_code},
		#{product_img_path},
		now(),
		now()
		);
		
  	</insert>
  	
  	<select id="matchingMyProductList" parameterType="Integer" resultType="com.kcFinder.dev.domain.product.MatchingMyProductList">
  
	SELECT t1.product_code,
		   t1.product_name,
		   t1.user_code,
		   t2.product_img_path
	  FROM user_product t1
	 INNER JOIN user_product_img t2 ON t1.product_code = t2.product_code
	 WHERE t1.user_code = #{userCode}
	   AND t1.product_code = (SELECT MAX(product_code) FROM user_product WHERE user_code = #{userCode});
  
  	</select>
  	
  	<select id="matchingMyProductPlusList" parameterType="Integer" resultType="com.kcFinder.dev.domain.product.MatchingMyProductPlusList">
  
	SELECT
	    c1.matching_product_code,
	    c1.kc_certification_num,
	    c1.matching_product_link,
	    c2.matching_kc_img_url
	FROM user_product t1
	LEFT JOIN matching_product c1 ON t1.product_code = c1.product_code
	LEFT JOIN matching_product_img c2 ON c1.matching_product_code = c2.matching_product_code
	WHERE t1.user_code = #{userCode} AND t1.product_code = #{productCode};
  
  	</select>
  	

    <!-- 결과 매핑 -->
    <resultMap id="ProductDetailResultMap" type="com.kcFinder.dev.web.dto.product.ProductDetailDto">
        <result property="userCode" column="user_code"/>
        <result property="productCode" column="product_code"/>
        <result property="productName" column="product_name"/>
        <result property="createDate" column="create_date"/>
        <result property="matchingProductCode" column="matching_product_code"/>
        <result property="kcCertificationNum" column="kc_certification_num"/>
        <result property="matchingProductLink" column="matching_product_link"/>
        <collection property="productImgPath" ofType="String" javaType="java.util.List" 
                   select="getProductImages" column="product_code"/>
        <collection property="matchingKcImgUrl" ofType="String" javaType="java.util.List" 
                   select="getMatchingImages" column="matching_product_code"/>
    </resultMap>

    <!-- 모든 상품 목록 조회 -->
    <select id="getAllProducts" resultMap="ProductDetailResultMap">
        SELECT DISTINCT
            up.user_code,
            up.product_code,
            up.product_name,
           	up.create_date,
            mp.matching_product_code,
            mp.kc_certification_num,
            mp.matching_product_link
        FROM user_product up
        LEFT JOIN matching_product mp ON up.product_code = mp.product_code
        ORDER BY up.product_code DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 상품 이미지 조회 -->
    <select id="getProductImages" resultType="String">
        SELECT product_img_path
        FROM user_product_img
        WHERE product_code = #{product_code}
    </select>

    <!-- 매칭된 KC 이미지 조회 -->
    <select id="getMatchingImages" resultType="String">
        SELECT matching_kc_img_url
        FROM matching_product_img
        WHERE matching_product_code = #{matching_product_code}
    </select>

    <!-- 전체 상품 수 조회 -->
    <select id="getTotalProductCount" resultType="int">
        SELECT COUNT(DISTINCT up.product_code)
        FROM user_product up
    </select>
  	
  	    <!-- 특정 유저의 상품 목록 조회 -->
    <select id="getProductsByUser" resultMap="ProductDetailResultMap">
        SELECT DISTINCT
            up.user_code,
            up.product_code,
            up.product_name,
            up.create_date,
            mp.matching_product_code,
            mp.kc_certification_num,
            mp.matching_product_link
        FROM user_product up
        LEFT JOIN matching_product mp ON up.product_code = mp.product_code
        WHERE up.user_code = #{userCode}
        ORDER BY up.product_code DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 특정 유저의 상품 수 조회 -->
    <select id="getTotalProductCountByUser" resultType="int">
        SELECT COUNT(DISTINCT up.product_code)
        FROM user_product up
        WHERE up.user_code = #{userCode}
    </select>
    
    </mapper>